<div class="banner">
     <div class="banner-content">
          <div id="navbar-container">
               <app-navbar></app-navbar>
          </div>
     </div>
</div>

<!-- Main content. Centered with 2 columns -->
<div class="main-container">
     <div class="content-wrapper">
          <!-- Left Wallet panel ==== -->
          <app-wallet-panel (walletSelected)="onWalletSelected($event)"></app-wallet-panel>

          <!-- Right form -->
          <div class="form-panel">
               <!-- Menu bar -->
               <div class="menu-bar">
                    <button class="menu-btn active" [class.active]="activeTab() === 'create'" (click)="setTab('create')">
                         <ng-icon name="heroPlusCircle" size="20" class="text-red-600"></ng-icon>
                         Create Credentials
                    </button>
                    <button class="menu-btn active" [class.active]="activeTab() === 'accept'" (click)="setTab('accept')">
                         <lucide-icon name="copy-plus" size="20" style="padding-top: 5px"></lucide-icon>
                         Accept Credentials
                    </button>
                    <button class="menu-btn" [class.active]="activeTab() === 'verify'" (click)="setTab('verify')">
                         <lucide-icon name="shield-ellipsis" size="23" style="padding-top: 5px"></lucide-icon>
                         Verify Credentials
                    </button>
                    <button class="menu-btn" [class.active]="activeTab() === 'delete'" (click)="setTab('delete')">
                         <ng-icon name="heroTrash" size="20" class="text-red-600"></ng-icon>
                         Delete Credentials
                    </button>
               </div>

               <!-- Create Menu -->
               @if (activeTab() === 'create') {
               <div>
                    <div class="submenu-info-text">
                         <div class="blue-button-submenu">
                              <ng-icon name="heroPlusCircle" size="27" class="text-red-600"></ng-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Create Credentials</h2>
                              <p class="submenu-info-secondary-text">Create Credentials to another XRPL adress</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Accept Menu -->
               @if (activeTab() === 'accept') {
               <div>
                    <div class="submenu-info-text">
                         <div class="green-button-submenu">
                              <lucide-icon name="copy-plus" size="27" style="padding-top: 5px"></lucide-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Accept Credentials</h2>
                              <p class="submenu-info-secondary-text">Accept Credentials from another XRPL adress</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Verify Menu -->
               @if (activeTab() === 'verify') {
               <div>
                    <div class="submenu-info-text">
                         <div class="orange-button-submenu">
                              <lucide-icon name="shield-ellipsis" size="27" style="padding-top: 5px"></lucide-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Verify Credentials</h2>
                              <p class="submenu-info-secondary-text">Verify Credentials have been accepted by another XRPL adress</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Delete Menu -->
               @if (activeTab() === 'delete') {
               <div>
                    <div class="submenu-info-text">
                         <div class="red-button-submenu">
                              <ng-icon name="heroTrash" size="27" class="text-red-600"></ng-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Delete Credentials</h2>
                              <p class="submenu-info-secondary-text">Delete Credentials to another XRPL adress</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Info Message -->
               @if (infoData(); as info) {
               <div class="info-message-wrapper">
                    <div class="info-panel">
                         <div class="info-text">
                              <div style="margin-bottom: 16px; line-height: 1.5; cursor: default">
                                   <ng-icon name="heroInformationCircle" size="20" class="text-blue-600" style="vertical-align: -4px; margin-right: 8px"></ng-icon>
                                   <code>{{ info.walletName }}</code>

                                   @switch (info.mode) { @case ('create') { @if (info.issuedByMe.length === 0) { has not issued any credentials yet. } @else { has issued <strong>{{ info.issuedByMe.length }}</strong> credential{{ info.issuedByMe.length === 1 ? '' : 's' }} @if (info.pendingIssued.length === 0) { — all accepted! } @else { :<br />
                                   <span style="margin-left: 24px">• {{ info.acceptedIssued.length }} accepted</span><br />
                                   <span style="margin-left: 24px">• <strong>{{ info.pendingIssued.length }} pending acceptance</strong></span>
                                   } } } @case ('accept') { @if (info.issuedToMe.length === 0) { has no credentials issued to it. } @else if (info.pendingToAccept.length === 0) { has no pending credentials to accept — all accepted! } @else { has <strong>{{ info.pendingToAccept.length }}</strong> pending credential{{ info.pendingToAccept.length === 1 ? '' : 's' }} to accept: } } @case ('delete') { @if (info.issuedByMe.length === 0) { has no credentials to delete. } @else { has
                                   <strong>{{ info.issuedByMe.length }}</strong> issued credential{{ info.issuedByMe.length === 1 ? '' : 's' }} that can be deleted: } } @case ('verify') { @if ((info.issuedToMe.length + info.issuedByMe.length) === 0) { is not involved in any credentials. } @else { is involved in <strong>{{ info.issuedToMe.length + info.issuedByMe.length }}</strong> credential{{ (info.issuedToMe.length + info.issuedByMe.length) === 1 ? '' : 's' }}:
                                   <br />
                                   @if (info.issuedToMe.length > 0) {
                                   <span style="margin-left: 24px">• {{ info.pendingToAccept.length }} pending to accept • {{ info.acceptedByMe.length }} accepted</span><br />
                                   } @if (info.issuedByMe.length > 0) {
                                   <span style="margin-left: 24px">• {{ info.pendingIssued.length }} issued & pending • {{ info.acceptedIssued.length }} accepted</span>
                                   } } } }
                              </div>

                              @if (info.credentialsToShow.length > 0) {
                              <div class="credential-info-panel" (click)="toggleInfoPanel()" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 14px 16px; cursor: pointer; user-select: none; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); transition: all 0.2s">
                                   <div class="info-header" style="display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #0369a1">
                                        <span>
                                             Credentials ({{ info.credentialsToShow.length }}) @if ((info.pendingToAccept.length + info.pendingIssued.length) > 0) { — <strong>{{ info.pendingToAccept.length + info.pendingIssued.length }} pending</strong>
                                             } @else { — all accepted }
                                        </span>
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0369a1" stroke-width="3" [style.transform]="infoPanelExpanded() ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.25s ease">
                                             <path d="M6 9l6 6 6-6" />
                                        </svg>
                                   </div>

                                   @if (infoPanelExpanded()) {
                                   <ul style="margin: 12px 0 0; padding-left: 22px; font-size: 0.9em; line-height: 1.7">
                                        @for (cred of info.credentialsToShow; track trackByCredentialIndex($index, cred)) {
                                        <li style="margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px">
                                             <app-tooltip-link [href]="txUiService.explorerUrl() + 'entry/' + cred.index" tooltipText="View Credential on XRPL Explorer">
                                                  <div style="font-weight: 500; margin-bottom: 4px">
                                                       @if (isCredentialAccepted(cred)) {
                                                       <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="3.5" style="margin-right: 6px; vertical-align: -2px">
                                                            <path d="M20 6 9 17l-5-5" />
                                                       </svg>
                                                       } @else {
                                                       <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="3.5" style="margin-right: 6px; vertical-align: -2px">
                                                            <path d="M18 6 6 18M6 6l12 12" />
                                                       </svg>
                                                       } {{ cred.CredentialType || 'Credential' }}
                                                       <span style="color: #888; font-size: 0.9em"> ({{ cred.Issuer === currentWallet().address ? 'you issued' : 'issued to you' }}) </span>
                                                  </div>
                                                  <div style="color: #555; font-size: 0.88em; margin-left: 20px">Index: {{ cred.index.slice(0,8) + '...' + cred.index.slice(-6) }}   {{ cred.Issuer === currentWallet().address ? 'Subject' : 'Issuer' }}: {{ (cred.Issuer === currentWallet().address ? cred.Subject : cred.Issuer)?.slice(0,8) + '...' + (cred.Issuer === currentWallet().address ? cred.Subject : cred.Issuer)?.slice(-6) }}</div>
                                             </app-tooltip-link>
                                        </li>
                                        }
                                   </ul>
                                   }
                              </div>
                              }
                         </div>
                    </div>
               </div>
               }

               <!-- Warning Message -->
               @if (txUiService.warningMessage) {
               <div class="warning-panel">
                    <ng-icon name="heroExclamationTriangle" size="20" class="text-yellow-600"></ng-icon>
                    <div class="warning-text" [innerHTML]="txUiService.safeWarning"></div>
               </div>
               }

               <form #theForm="ngForm" class="send-form">
                    <div class="tab-content-container">
                         <div [@tabTransition]="activeTab()">
                              <!-- Unified Credential Dropdown - Works for accept, delete, verify -->
                              @if (activeTab() !== 'create') {
                              <div class="form-group">
                                   <label for="selectCredential">Select Credential</label>
                                   <p class="form-hint">Select an existing credential attached to the current wallet.</p>
                                   <app-select-search-dropdown [items]="credentialItems()" [value]="selectedCredentialItem()" (valueChange)="onCredentialSelected($event)" placeholder="Search by type, issuer, or ID..." emptyMessage="No credentials found"> </app-select-search-dropdown>
                              </div>
                              }

                              <!-- Subject and destination -->
                              @if (activeTab() === 'create') {
                              <div class="form-row">
                                   <!-- Subject -->
                                   <div class="form-group">
                                        <label for="destinationSubject">Subject</label>
                                        <p class="form-hint">The subject of the credential.</p>
                                        <app-select-search-dropdown [items]="destinationItems()" [value]="selectedDestinationItem()" (valueChange)="onDestinationSelected($event)" placeholder="Enter or select destination address" emptyMessage="No wallets available"> </app-select-search-dropdown>
                                   </div>

                                   <!-- Credential Type -->
                                   <div class="form-group">
                                        <label for="credentialExpiration">Credential Expiration</label>
                                        <p class="form-hint">Credential expiration.</p>

                                        <div class="expiration-input-group">
                                             <input type="datetime-local" [(ngModel)]="credential().subject.expirationDate" name="expirationDate" step="1" (focus)="populateDefaultDateTime()" class="expiration-input" />

                                             <div class="expiration-buttons">
                                                  <button type="button" (click)="setToNow()" class="btn-small btn-primary-blue">Now</button>
                                                  <button type="button" (click)="addToExpiration(10)" class="btn-small btn-primary-blue">+10s</button>
                                                  <button type="button" (click)="addToExpiration(30)" class="btn-small btn-primary-blue">+30s</button>
                                                  <button type="button" (click)="addToExpiration(60)" class="btn-small btn-primary-blue">+1min</button>
                                                  <button type="button" (click)="addToExpiration(300)" class="btn-small btn-primary-blue">+5min</button>
                                             </div>
                                        </div>
                                   </div>
                                   <!-- <div class="form-group">
                                        <label for="credentialExpiration">Credential Expiration</label>
                                        <p class="form-hint">Credential expiration.</p>
                                        <input type="datetime-local" [(ngModel)]="credential().subject.expirationDate" name="expirationDate" step="1" (focus)="populateDefaultDateTime()" />
                                   </div> -->
                              </div>
                              }

                              <!-- Credential Type and URI -->
                              @if (activeTab() === 'create') {
                              <div class="form-row">
                                   <!-- Credential Type-->
                                   <div class="form-group">
                                        <label for="credentialType">Credential Type</label>
                                        <p class="form-hint">A hex-encoded value to identify the type of credential from the issuer.</p>
                                        <input type="text" [(ngModel)]="credential().credential_type" name="credential_type" />
                                   </div>

                                   <!-- URI -->
                                   <div class="form-group">
                                        <label for="uri">URI</label>
                                        <p class="form-hint">Additional data about the credential (i.e. a link to the VC document).</p>
                                        <input type="text" [(ngModel)]="credential().uri" name="uri" />
                                   </div>
                              </div>
                              }

                              <!-- Verify Credential Type -->
                              @if (activeTab() === 'verify') {
                              <div class="form-row">
                                   <div class="form-group">
                                        <label for="credentialType">Credential Type</label>
                                        <p class="form-hint">A hex-encoded value to identify the type of credential from the issuer.</p>
                                        <input type="text" [(ngModel)]="credentialType" name="credentialType" />
                                   </div>
                              </div>
                              }

                              <!-- Credential ID -->
                              @if (activeTab() !== 'create' && (activeTab() === 'delete' || activeTab() === 'verify' || activeTab() === 'accept')) {
                              <div class="form-row">
                                   <div class="form-group">
                                        <label for="credentialId">Credential ID</label>
                                        <p class="form-hint">Ledger hash containing the credential.</p>
                                        <input type="text" id="credentialID" [(ngModel)]="credentialID" name="credentialID" />
                                   </div>
                              </div>
                              }

                              <app-transaction-options [showWhenTab]="['create', 'delete','accept']" [activeTab]="activeTab" [multiSigningEnabled]="txUiService.multiSigningEnabled" [regularKeySigningEnabled]="txUiService.regularKeySigningEnabled" />

                              <!-- Action buttons -->
                              <div class="button-row">
                                   @if (activeTab() === 'create') {
                                   <button type="button" class="btn-primary-blue" (click)="createCredential()" [disabled]="txUiService.spinner() || !(walletManagerService.hasWallets$ | async)">{{ txUiService.spinner() ? 'Processing...' : 'Create Credential' }}</button>
                                   } @else if (activeTab() === 'accept') {
                                   <button type="button" class="btn-primary-green" (click)="acceptCredentials()" [disabled]="txUiService.spinner() || !(walletManagerService.hasWallets$ | async)">{{ txUiService.spinner() ? 'Processing...' : 'Accept Credential' }}</button>
                                   } @else if (activeTab() === 'delete') {
                                   <button type="button" class="btn-primary-red" (click)="deleteCredentials()" [disabled]="txUiService.spinner() || !(walletManagerService.hasWallets$ | async)">{{ txUiService.spinner() ? 'Processing...' : 'Delete Credential' }}</button>
                                   } @else if(activeTab() === 'verify'){
                                   <button type="button" class="btn-primary-orange" (click)="verifyCredential(false)" [disabled]="txUiService.spinner() || !(walletManagerService.hasWallets$ | async)">{{ txUiService.spinner() ? 'Processing...' : 'Verify Credential' }}</button>
                                   }
                                   <button type="button" class="btn-secondary-clear-fields" [disabled]="!(walletManagerService.hasWallets$ | async)" (click)="clearFields()">Clear Fields</button>
                              </div>
                         </div>

                         <!-- Execution time -->
                         <div style="display: flex">
                              <input type="text" [(ngModel)]="executionTime" name="executionTime" readonly />
                         </div>
                         <app-transaction-preview></app-transaction-preview>
                    </div>
               </form>
          </div>
     </div>
</div>

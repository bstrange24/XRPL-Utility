<div class="banner">
     <div class="banner-content">
          <div id="navbar-container">
               <app-navbar></app-navbar>
          </div>
     </div>
</div>

<!-- Main content. Centered with 2 columns -->
<div class="main-container">
     <div class="content-wrapper">
          <!-- Left Wallet panel ==== -->
          <app-wallet-panel (walletSelected)="onWalletSelected($event)"></app-wallet-panel>

          <!-- Right form -->
          <div class="form-panel">
               <!-- Menu bar -->
               <div class="menu-bar">
                    <button class="menu-btn active" [class.active]="activeTab() === 'create'" (click)="setTab('create')">
                         <ng-icon name="heroPlusCircle" size="20" class="text-red-600"></ng-icon>
                         Create Check
                    </button>
                    <button class="menu-btn" [class.active]="activeTab() === 'cash'" (click)="setTab('cash')">
                         <ng-icon name="heroCurrencyDollar" size="20" class="text-red-600"></ng-icon>
                         Cash Check
                    </button>
                    <button class="menu-btn" [class.active]="activeTab() === 'cancel'" (click)="setTab('cancel')">
                         <ng-icon name="heroTrash" size="20" class="text-red-600"></ng-icon>
                         Cancel Check
                    </button>
               </div>

               <!-- Create Menu -->
               @if (activeTab() === 'create') {
               <div>
                    <div class="submenu-info-text">
                         <div class="blue-button-submenu">
                              <ng-icon name="heroPlusCircle" size="27" class="text-red-600"></ng-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Create Check</h2>
                              <p class="submenu-info-secondary-text">Create a check to another XRPL address</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Cash Menu -->
               @if (activeTab() === 'cash') {
               <div>
                    <div class="submenu-info-text">
                         <div class="green-button-submenu">
                              <ng-icon name="heroCurrencyDollar" size="27" class="text-red-600"></ng-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Cash Check</h2>
                              <p class="submenu-info-secondary-text">Cash check sent from another XRPL address</p>
                         </div>
                    </div>
               </div>
               }

               <!-- Cancel Menu -->
               @if (activeTab() === 'cancel') {
               <div>
                    <div class="submenu-info-text">
                         <div class="red-button-submenu">
                              <ng-icon name="heroTrash" size="27" class="text-red-600"></ng-icon>
                         </div>
                         <div>
                              <h2 class="submenu-info-main-text">Cancel Check</h2>
                              <p class="submenu-info-secondary-text">Cancel check create from the selected account</p>
                         </div>
                    </div>
               </div>
               }
               <!-- @if (isLoadingChecks()) { -->
               <!-- <div class="combobox-empty">Loading checks...</div> -->
               <!-- } -->

               <!-- Info Message -->
               @if (infoData(); as info) {
               <div class="info-message-wrapper">
                    <div class="info-panel">
                         <div class="info-text">
                              <div style="margin-bottom: 16px; line-height: 1.5; cursor: default">
                                   <ng-icon name="heroInformationCircle" size="20" class="text-blue-600" style="vertical-align: -4px; margin-right: 8px"></ng-icon>
                                   <code>{{ info.walletName }}</code>
                                   @if (info.checkCount === 0) { has no outstanding checks. } @else {
                                   <!-- else block -->
                                   has <strong>{{ info.checkCount }}</strong> check{{ info.checkCount === 1 ? '' : 's' }} @switch (activeTab()) {
                                   <!-- Display message based on active tab -->
                                   @case ('create') { created. } @case ('cash') { that can be cashed. } @case ('cancel') { that can be cancelled. } } }
                              </div>

                              @if (info.checkCount > 0) {
                              <div class="credential-info-panel" (click)="toggleInfoPanel()" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 14px 16px; cursor: pointer; user-select: none; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); transition: all 0.2s">
                                   <div class="info-header" style="display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #0369a1">
                                        <span>
                                             @switch (activeTab()) {
                                             <!-- Display message based on active tab -->
                                             @case ('create') { Outstanding Checks } @case ('cash') { Cashable Checks } @case ('cancel') { Cancellable Checks } } ({{ info.checkCount }})
                                        </span>
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0369a1" stroke-width="3" [style.transform]="infoPanelExpanded() ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.25s ease">
                                             <path d="M6 9l6 6 6-6" />
                                        </svg>
                                   </div>

                                   @if (infoPanelExpanded()) {
                                   <ul style="margin: 12px 0 0; padding-left: 22px; font-size: 0.9em; line-height: 1.7">
                                        @for (check of info.checksToShow; track check.id) {
                                        <li style="margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px">
                                             <app-tooltip-link [href]="txUiService.explorerUrl() + 'entry/' + check.index" tooltipText="View Check on XRPL Explorer">
                                                  <div style="font-weight: 500; margin-bottom: 4px">
                                                       {{ check.amount }}
                                                       <!-- Display message based on active tab -->
                                                       @if (activeTab() === 'create') {
                                                       <!-- create active tab -->
                                                       → {{ check.destination.slice(0,7) + '...' + check.destination.slice(-7) }} } @if (activeTab() === 'cash') {
                                                       <!-- cash active tab -->
                                                       ← {{ check.sender.slice(0,7) + '...' + check.sender.slice(-7) }} } @if (activeTab() === 'cancel') {
                                                       <!-- cancel active tab -->
                                                       → {{ check.destination.slice(0,7) + '...' + check.destination.slice(-7) }} }
                                                  </div>

                                                  <div style="color: #555; font-size: 0.88em; display: flex; align-items: center; gap: 8px">
                                                       <span>Check ID:</span>
                                                       <code style="font-size: 0.95em">{{ check.index }}</code>
                                                  </div>

                                                  @if (check.destinationTag) {
                                                  <div style="color: #555; font-size: 0.88em"><span>Dest Tag: </span> <code>{{ check.destinationTag }}</code></div>
                                                  } @if (check.expiration) {
                                                  <div style="color: #555; font-size: 0.88em"><span>Expires: </span> <code>{{ formatXrplTimestamp(check.expiration) }}</code></div>
                                                  } @if (check.invoiceId) {
                                                  <div style="color: #555; font-size: 0.88em"><span>Invoice ID: </span> <code>{{ formatInvoiceId(check.invoiceId) }}</code></div>
                                                  }
                                             </app-tooltip-link>

                                             <button (click)="copyAndToast(check.index, 'Check ID'); $event.stopPropagation()" class="copy-btn" title="Copy Check ID" style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.7; margin-left: auto">
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                       <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                       <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                  </svg>
                                             </button>
                                        </li>
                                        }
                                   </ul>
                                   }
                              </div>
                              }
                         </div>
                    </div>
               </div>
               }

               <!-- Warning Message -->
               @if (txUiService.warningMessage) {
               <div class="warning-panel">
                    <ng-icon name="heroExclamationTriangle" size="20" class="text-yellow-600"></ng-icon>
                    <div class="warning-text" [innerHTML]="txUiService.safeWarning"></div>
               </div>
               }

               <form #theForm="ngForm" class="send-form">
                    <div class="tab-content-container">
                         <div [@tabTransition]="activeTab()">
                              @switch (activeTab()) {
                              <!-- Create -->
                              @case ('create') {
                              <!-- Currency + Amount -->
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Currency Code</label>
                                        <select id="currencyField" [(ngModel)]="currencyFieldDropDownValue" (ngModelChange)="onCurrencyChange($event)" name="currencyField">
                                             @for (curr of availableCurrencies; track curr) {
                                             <option [value]="curr">{{ curr }}</option>
                                             }
                                        </select>
                                   </div>
                                   <div class="form-group">
                                        <label>Amount</label>
                                        <input type="text" [(ngModel)]="amountField" name="amountField" placeholder="e.g. 10.5" />
                                   </div>
                              </div>

                              <!-- Issuer (only when not XRP) -->
                              @if (currencyFieldDropDownValue() !== 'XRP') {
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Issuer</label>
                                        <select id="issuerFields" [(ngModel)]="issuerFields" (ngModelChange)="onIssuerChange($event)" name="issuerFields">
                                             @for (iss of issuers; track iss.address) {
                                             <option [value]="iss.address">{{ iss.name }} ({{ iss.address | slice:0:8 }}...{{ iss.address | slice:-6 }})</option>
                                             }
                                        </select>
                                   </div>
                                   <div class="form-group">
                                        <label>Currency Balance</label>
                                        <input type="text" [(ngModel)]="currencyBalanceField" name="currencyBalanceField" readonly />
                                   </div>
                              </div>
                              }

                              <!-- Destination + Tag -->
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Destination</label>

                                        <div class="combobox-container" (clickOutside)="closeDropdown()">
                                             <input #dropdownOrigin type="text" [value]="destinationDisplay()" (input)="onDestinationInput($event)" (focus)="openDropdown()" (keydown)="onKeyDown($event)" placeholder="Enter or select destination address" class="combobox-input" autocomplete="off" />

                                             <button class="combobox-toggle" (click)="toggleDropdown()" type="button">
                                                  <lucide-icon name="chevron-down" size="18"></lucide-icon>
                                             </button>
                                        </div>
                                   </div>

                                   <!-- Destination Dropdown template -->
                                   <ng-template #dropdownTemplate>
                                        <div class="combobox-wrapper" (click)="$event.stopPropagation()">
                                             <div class="combobox-dropdown-overlay">
                                                  @for (dest of filteredDestinations(); track trackByWalletAddress($index, dest)) {
                                                  <div class="combobox-item" [class.disabled]="dest.address === currentWallet().address" [class.highlighted]="highlightedIndex() === $index" (click)="selectDestination(dest.address)">
                                                       <div class="item-name">
                                                            {{ dest.name || 'Wallet' }} @if (dest.address === currentWallet().address) {
                                                            <span class="self-badge"> Current Account </span>
                                                            }
                                                       </div>
                                                       <div class="item-address">{{ dest.address.slice(0, 6) }}...{{ dest.address.slice(-6) }}</div>
                                                  </div>
                                                  } @empty {
                                                  <div class="combobox-empty">No matching addresses</div>
                                                  }
                                             </div>
                                        </div>
                                   </ng-template>

                                   <div class="form-group">
                                        <label>Destination Tag</label>
                                        <input type="text" [(ngModel)]="destinationTagField" name="destinationTagField" />
                                   </div>
                              </div>

                              <!-- Source Tag & Invoice ID (create only) -->
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Source Tag (opt)</label>
                                        <input type="text" [(ngModel)]="sourceTagField" name="sourceTagField" />
                                   </div>

                                   <div class="form-group">
                                        <label>Invoice ID (opt)</label>
                                        <input type="text" [(ngModel)]="invoiceIdField" name="invoiceIdField" />
                                   </div>
                              </div>

                              <!-- Expiration (create only) -->
                              <div class="form-row">
                                   <div class="form-group" style="padding-bottom: 10px">
                                        <label>Expiration Amount</label>
                                        <input type="text" id="expirationTimeField" placeholder="Enter time" [(ngModel)]="expirationTimeField" name="expirationTimeField" />
                                   </div>

                                   <div class="form-group" style="padding-bottom: 10px">
                                        <label>Expiration Time</label>
                                        <select id="checkExpirationTime" [(ngModel)]="checkExpirationTime" name="checkExpirationTime">
                                             <option value="seconds">Seconds</option>
                                             <option value="minutes">Minutes</option>
                                             <option value="hours">Hours</option>
                                             <option value="days">Days</option>
                                        </select>
                                   </div>
                              </div>
                              }

                              <!-- Currency + Amount (shared with create) -->
                              @case ('cash') {
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Currency Code</label>
                                        <select id="currencyField" [(ngModel)]="currencyFieldDropDownValue" (ngModelChange)="onCurrencyChange($event)" name="currencyField">
                                             @for (curr of availableCurrencies; track curr) {
                                             <option [value]="curr">{{ curr }}</option>
                                             }
                                        </select>
                                   </div>

                                   <div class="form-group">
                                        <label>Amount</label>
                                        <input type="text" [(ngModel)]="amountField" name="amountField" placeholder="e.g. 10.5" />
                                   </div>
                              </div>

                              <!-- Issuer (only when not XRP) -->
                              @if (currencyFieldDropDownValue() !== 'XRP') {
                              <div class="form-row">
                                   <div class="form-group">
                                        <label>Issuer</label>
                                        <select id="issuerField" [(ngModel)]="selectedIssuer" name="issuerField" (ngModelChange)="onIssuerChange($event)">
                                             <option value="" disabled selected>Select an issuer</option>
                                             @for (iss of issuers; track iss.address; let i = $index) {
                                             <option [value]="iss.address">{{ iss.name || 'Wallet ' + (i + 1) }} ({{ iss.address | slice:0:6 }}...{{ iss.address | slice:-4 }})</option>
                                             }
                                        </select>
                                   </div>

                                   <div class="form-group">
                                        <label>Currency Balance</label>
                                        <input type="text" [(ngModel)]="currencyBalanceField" name="currencyBalanceField" readonly />
                                   </div>
                              </div>
                              } } }

                              <!-- Unified Check ID Dropdown - Works for cash & cancel -->
                              @if (activeTab() === 'cash' || activeTab() === 'cancel') {
                              <div class="form-row" style="margin-bottom: 0.8em">
                                   <div class="form-group">
                                        <label for="checkSelect">Select Check:</label>
                                        <div class="combobox-container" (clickOutside)="closeCheckIdDropdown()">
                                             <input #checkInput type="text" [value]="checkIdInputDisplay()" (input)="onCheckIdInput($event)" (focus)="openCheckIdDropdown()" (keydown)="onKeyDown($event)" placeholder="Search or select a check..." class="combobox-input" autocomplete="off" />

                                             <button class="combobox-toggle" (click)="openCheckIdDropdown()" type="button">
                                                  <lucide-icon name="chevron-down" size="18"></lucide-icon>
                                             </button>
                                        </div>
                                   </div>
                              </div>

                              <!-- Shared Check Dropdown Template -->
                              <ng-template #unifiedCheckDropdownTemplate>
                                   <div class="combobox-wrapper" (click)="$event.stopPropagation()">
                                        <div class="combobox-dropdown-overlay" style="max-height: 300px; overflow-y: auto">
                                             @for (check of filteredCheckIds(); track check.id) {
                                             <div class="combobox-item" [class.highlighted]="highlightedCheckIdIndex() === $index" (click)="selectCheckId(check)">
                                                  <div class="item-name font-medium">{{ formatIOUXrpAmountOutstanding(check.sendMax) }} @if (activeTab() === 'cash') { ← {{ (check.sender || 'Unknown').slice(0,8) + '...' + (check.sender || '').slice(-6) }} } @else { → {{ (check.destination || 'Unknown').slice(0,8) + '...' + (check.destination || '').slice(-6) }} }</div>
                                                  <div class="item-address text-sm text-gray-600">
                                                       {{ check.id.slice(0, 16) }}...{{ check.id.slice(-12) }}
                                                       <span class="mx-2">•</span>
                                                       Check ID
                                                  </div>
                                             </div>
                                             } @empty {
                                             <div class="combobox-empty">@if (activeTab() === 'cash') { No checks to cash } @else { No checks to cancel }</div>
                                             }
                                        </div>
                                   </div>
                              </ng-template>
                              }

                              <app-transaction-options [showWhenTab]="['create', 'cash','cancel']" [activeTab]="activeTab" [multiSigningEnabled]="txUiService.multiSigningEnabled" [regularKeySigningEnabled]="txUiService.regularKeySigningEnabled" />

                              <!-- Action buttons -->
                              <div class="button-row">
                                   @if (activeTab() === 'create') {
                                   <!-- <button type="button" class="btn-primary-blue" (click)="createCheck()" [disabled]="!canCreateCheck() || txUiService.spinner()">{{ txUiService.spinner() ? 'Processing...' : 'Create Check' }}</button> -->
                                   <button type="button" class="btn-primary-blue" (click)="createCheck()" [disabled]="txUiService.spinner()">{{ txUiService.spinner() ? 'Processing...' : 'Create Check' }}</button>
                                   } @else if (activeTab() === 'cash') {
                                   <!-- <button type="button" class="btn-primary-green" (click)="cashCheck()" [disabled]="!canCashCheck() || txUiService.spinner()">{{ txUiService.spinner() ? 'Processing...' : 'Cash Check' }}</button> -->
                                   <button type="button" class="btn-primary-green" (click)="cashCheck()" [disabled]="txUiService.spinner()">{{ txUiService.spinner() ? 'Processing...' : 'Cash Check' }}</button>
                                   } @else if(activeTab() === 'cancel') {
                                   <!-- <button type="button" class="btn-primary-red" (click)="cancelCheck()" [disabled]="!canCancelCheck() || txUiService.spinner()">>{{ txUiService.spinner() ? 'Processing...' : 'Cancel Check' }}</button> -->
                                   <button type="button" class="btn-primary-red" (click)="cancelCheck()" [disabled]="txUiService.spinner()">>{{ txUiService.spinner() ? 'Processing...' : 'Cancel Check' }}</button>
                                   }
                                   <button type="button" class="btn-secondary-clear-fields" (click)="clearFields()" [disabled]="txUiService.spinner()">Clear Fields</button>
                              </div>
                         </div>

                         <!-- Execution time -->
                         <div style="display: flex">
                              <input type="text" [(ngModel)]="executionTime" name="executionTime" readonly />
                         </div>
                         <app-transaction-preview></app-transaction-preview>
                    </div>
               </form>
          </div>
     </div>
</div>
